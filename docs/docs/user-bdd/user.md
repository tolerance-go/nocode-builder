[[toc]]

<br />

👨‍💻 开发中
✔️ 已实现
☑️ 已完成

<br />

# 平台用户行为手册

## ✔️ 假如我拖动按钮组件到舞台上存在子组件的 Flex 组件，并且鼠标悬停在组件上，那么应该只显示和鼠标关系最近的坍缩状态的占位插槽而不包括组件嵌套层级上所有的插槽 {#hover-nearest-collapsed-placeholder-slot}

**准备**

当，我已经登录

并且，创建了一个视图项目

并且，点击激活了它

并且，向舞台添加了一个 Flex 布局组件

并且，向 Flex 布局组件添加了一个按钮组件

**描述**

当，我拖动一个组件到舞台上时

并且，鼠标悬停在按钮组件上

那么，应该只显示按钮附近的占位插槽而不包括 Flex 组件的占位插槽

**分析**

- 原因：就是鼠标先进入了父级的插槽，然后再进入子组件的插槽，父级的插槽的占位插槽会先显示，而目前只有 drop 或者取消的时候，才结束显示占位插槽，也就是说 dragLeave 不会触发关闭，并且进入子组件禁止了触发父组件的 dragEnter，所以父组件的插槽才会一直显示
  - 解决：占位插槽兄弟之间的竞态在 slot 内部已经维护并解决了，所以这里要解决 slot 父子之间的竞态，不能同时显示，子组件显示占位的时候，父 slot 要关闭
    - 在外部状态中维护进入插槽的节点的 key 的路径集合，然后在组件内连接并且处理

**依赖**

- 外部状态需要维护一个集合，用来记录当前拖拽鼠标进入的插槽的 key 的路径集合，并且支持维护他方法
- 插槽组件层面连接到全局状态库，以便于获取当前拖拽鼠标进入的插槽的 key 的路径集合，并且对内部占位插槽的显示和隐藏做出判断
- 占位插槽组件需要提供一个接口来暂时关闭占位插槽

## ✔️ 假如我开始拖动组件，舞台上的 Flex 组件应该变化为可见样式 {#drag-component-flex-visible}

**前提准备**

当，我已经登录

并且，创建了一个视图项目

并且，点击激活了它

并且，向舞台添加了一个 Flex 布局组件

**描述**

当，我开始拖动组件到舞台上时

那么，Flex 组件应该显示为可见样式

并且，它有 padding 和虚线边框

**依赖**

- Flex 需要可以定义自己的插槽数量和名称
  - 其他组件同样需要可以定义自己的插槽数量和名称
  - 添加组件到舞台上后，系统需要根据组件的插槽定义，默认添加相应的插槽子结构

## ✔️ 假如我拖动组件进入部件相邻后一个占位插槽放置后，应该可以看到该组件插入到正确的位置中 {#insert-slot-next}

**前提准备**

当，我已经登录

并且，创建了一个视图项目

并且，点击激活了它

并且，放置了一个按钮组件到舞台上

**描述**

当，我拖动一个另一个组件到舞台上按钮组件的后半部分

并且，继续拖动组件到后相邻的占位插槽上

并且，放置组件后

那么，该组件应该插入到该组件的后面

## 👨‍💻 假如用户拖动 Flex 布局组件到舞台上，应该可以设置布局参数和添加内容元素 {#drag-flex-layout-component-to-stage-set-layout-params-and-add-content-elements}

**前提准备**

当，我已经登录

并且，创建了一个视图项目

并且，点击激活了它

**描述**

当，我拖动 Flex 布局组件到舞台上时

那么，预览组件应该显示横向布局

并且，内容有 3 个虚线边框的占位元素

并且，他们有固定尺寸大小

当，成功放置后

那么，他应该显示空内容，并且尺寸为默认

当，拖动其他组件的时候，Flex 应该向其内部添加内容元素

当，添加内容元素后

并且，再次拖动其他组件的时候

并且，拖动鼠标进入部件的内容插槽后

那么，相应临近的占位插槽应该高亮显示

并且，可以拖动鼠标进入后放置

当，聚焦 Flex 组件后

那么，配置面板应该显示可配的相关布局参数

并且，修改参数后立即更新舞台预览效果

## ✔️ 假如用户点击舞台上的部件后，侧边栏应该展示可配置信息 {#click-component-show-config-panel}

**前提准备**

当，我已经登录

并且，创建了一个视图项目

并且，点击激活了它

**描述**

当，我点击舞台上的部件后

那么，我应该在右侧侧边栏展示该部件的可配置表单信息

并且，该部件应该进入选中和聚焦状态

**依赖**

- 🟢 Widget 组件需要提供一些接口，用来展示选中和聚焦状态
- 🟢 需要新增一个 PropsForm 组件，用来展示和编辑当前聚焦 widget 的可配置信息
  - 🟢 需要新增一个 JsonForm 组件，用来静态配置表单界面
- 🟢 需要新增一个 WidgetPropsPanel 组件，用来对 props 信息进行展示和交互
  - 🟢 WidgetPropsPanel 需要连接到全局状态库，以便于展示当前聚焦和选中 widget 的信息
- 🟢 全局状态库需要维护当前聚焦和选中 widget 的信息
  - 🟢 需要单独维护 widget 对应的组件的 props 配置信息，根据 lib 和 name 进行关联
  - 🟢 widgetData 需要维护对应的 props 数据

## ✔️ 假如用户拖动组件进入部件后，应该根据鼠标在部件内的位置选择靠近的占位插槽进行展示 {#drag-component-select-closest-slot}

**前提准备**

当，我已经登录

并且，创建了一个视图项目

并且，点击激活了它

**描述**

当，我拖动一个组件到舞台上时

并且，鼠标进入部件

那么，应该显示距离鼠标最近的占位插槽

**依赖**

- SlotItem 需要可以知道，拖动过程中，鼠标距离内部哪个占位插槽最近
  - Placeholder 无法提前渲染计算位置，所以要根据鼠标在 Widget 中的位置计算逻辑上最近的插槽
- Placeholder 需要提供一个是否是距离鼠标最近插槽的接口，控制渲染

## ✔️ 假如用户拖动组件时，鼠标进入占位插槽，然后放置，占位插槽坍缩状态应该重置为初始状态 {#reset-placeholder-collapse-state-when-drop}

**前提准备**

当，我已经登录

并且，创建了一个视图项目

并且，点击激活了它

**描述**

当，我拖动一个组件到舞台上时

并且，鼠标进入占位插槽时

那么，占位插槽应该展开

当，放置组件后

那么，下次进入该占位插槽相邻组件时，占位插槽应该显示坍缩状态

## ✔️ 假如用户拖动组件悬停组件上时，相邻插槽应该有鼠标触发的渐变效果 {#drag-hover-slot}

**前提准备**

当，我已经登录

并且，创建了一个视图项目

并且，点击激活了它

**描述**

当，我拖动一个组件到舞台上时

并且，鼠标悬停在组件上时

那么，应该显示相邻的插槽

并且，插槽应该显示较小的尺寸

当，鼠标进入插槽时

那么，插槽应该动画显示到组件的实际渲染的样子

**依赖**

- Placeholder
  - 需要增加一个坍缩状态，并且可以通过鼠标触发恢复到正常状态
  - 需要渲染前就知道自己的实际尺寸大小，以便于执行过渡动画效果
  - 需要知道自己和悬停组件的位置关系，是在 x 轴与之相邻还是 y 轴，以便于确定初始大小

## ✔️ 假如用户可以拖动组件的时候，hover 部件相邻的插槽才应该显示。 {#hover-slot-when-dragging-component}

**前提准备**

当，我已经登录

并且，创建了一个视图项目

并且，点击激活了它

**描述**

当，我拖动一个组件到舞台上时

并且，只有鼠标悬停在组件上时

那么，应该显示相邻的插槽

并且，其余插槽应该隐藏

**依赖**

- Placeholder 组件需要可以发现自己是不是当前拖动中鼠标悬停相邻的插槽
  - Placeholder 组件需要暴露接口，控制自己是不是当前鼠标悬停组件相邻的插槽
  - ~~Placeholder 组件需要提供接口通知外部拖拽是不是进入和离开该插槽~~
- Widget 可以通知外部，拖拽进入和离开的时机
  - [Widget 组件需要提供一组回调函数，当 hover 在部件上时或者离开时，可以触发它](../system-apis.md#widget-drag-enter-and-leave-api)
- Slot 需要可以管理内部所有 Widget 当前拖拽进入离开的状态
  - Slot 需要向当前拖拽悬停组件的 widget 的相邻 Placeholder 组件提示它是其相邻插槽
  - Slot 需要可以管理当前鼠标悬停的组件是哪个的状态
- SlotItem 需要只处理 widget 的 dragEnter
  - 因为如果同时处理 dragLeave，交替触发，插槽会闪烁；结合监听取消拖拽事件，清空上次遗留的状态

## ✔️ 假如用户拖动组件的时候，预览图片应该显示组件实际渲染的样子。

**前提准备**

当，我已经登录

并且，创建了一个视图项目

并且，点击激活了它

**描述**

当，我拖动一个组件到舞台上时

那么，插槽应该显示组件实际渲染的样子

并且，鼠标移动到插槽附近时，才应该显示插槽预览

并且，插槽的透明度应该为 0.5

并且，插槽的滤镜应该为蓝色

## ✔️ 假如用户可以拖动组件的时候，预览图片应该显示组件实际渲染的样子。 {#preview-component-render}

**前提准备**

当，我已经登录

并且，创建了一个视图项目

并且，点击激活了它

**描述**

当，我拖动一个组件到舞台上时

那么，拖动中的预览图应该显示组件实际渲染的样子

## ✔️ 假如用户应该看不到没有注册组件实现的组件。 {#hide-unregistered-component}

**前提准备**

当，我已经登录

并且，创建了一个视图项目

并且，点击激活了它

**描述**

当，我点击组件库时

那么，应该可以看到组件库

并且，可以看到组件库中所有组件

但是，不包括那些没有注册组件实现的组件

## ✔️ 假如用户拖动组件的时候，舞台部件的插槽应该显示，其余时间应该隐藏。{#slot-display-dragging}

**前提准备**

当，我已经登录

并且，创建了一个视图项目

并且，点击激活了它

**描述**

当，我准备拖动一个组件到舞台上前

那么，舞台部件插槽应该隐藏

当，我拖动一个组件到舞台上时

那么，应该显示舞台部件的插槽

并且，拖动结束后插槽应该隐藏

## 假如用户可以将组件拖动到根部件下的空插槽中 {#use-comp-in-slt-in-root-slot}

**前提准备**

当，我已经登录

并且，创建了一个视图项目

并且，点击激活了它

**描述**

当，我拖动一个组件到根部件下的空插槽中

并且，放置组件后

那么，应该将组件插入到根部件下

并且，下一次我拖动组件到根部件下时

那么，应该可以看到元素插槽前后的占位插槽

## 假如我希望拖动组件到舞台上，如果只有根部件，那么它的子插槽区域应该是整个舞台区域进行高亮 {#user-drag-component-to-stage-if-root-only-then-its-child-slot-area-should-be-highlighted}

**前提准备**

当，我已经登录

并且，创建了一个视图项目

并且，点击激活了它

**描述**

当，我拖动一个组件到舞台上时

那么，应该只有根部件

并且，它的子插槽区域应该是整个舞台区域进行高亮

## 假如我希望可以复制 url，在新浏览器中打开可以恢复之前的激活的项目

当，我点击项目节点的时候

那么，url 应该显示当前的项目 key

当，我复制 url 并且在新窗口打开的时候

那么，页面应该恢复之前的激活的项目

并且，项目树应该恢复之前的激活的项目

并且，项目树层级打开

## 假如我可以将部件拖动到舞台上 {#我可以将部件拖动到舞台上}

当，我点击部件库时

那么，部件库的抽屉应该弹出

并且，我可以看到相应的部件卡片

当，我将部件卡片拖动到舞台上时

那么，舞台上对应位置会出现高亮显示

当，我松开鼠标，拖动结束时

那么，应该在部件结构中创建一个新的部件节点

## 假如用户拖拽组件可以生成预览图，并且位置在鼠标箭头的右下方 {#用户拖拽组件可以生成预览图，并且位置在鼠标箭头的右下方}

当，我拖拽一个组件准备到舞台上时

那么，应该在鼠标箭头附近应该生成一个预览图

并且，预览图的位置在鼠标箭头的右下方

## 假如用户拖拽组件到舞台的部件上方时，部件下子插槽区域应该自动高亮。 {#用户拖拽组件到舞台的部件上方时，部件下子插槽区域应该自动高亮。}

**前提准备**

当，我已经登录

并且，舞台上已经有一个按钮组件

**描述**

当，我拖拽一个组件到舞台的部件上方时

那么，该部件下所有子插槽区域应该自动高亮

并且，包括已经填充的子插槽区域
